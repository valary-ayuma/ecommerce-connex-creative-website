<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout | Connex Creative</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600&display=swap" rel="stylesheet">
    <script src="header.js"></script>
    <style>
        :root { --primary-color: #5d2595; }
        body { font-family: 'Open Sans', sans-serif; background-color: #f4f4f4; }
        .checkout-container { max-width: 800px; margin: 40px auto; padding: 20px; background: white; border-radius: 10px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1 { font-family: 'Playfair Display', serif; font-size: 2em; color: #2c3e50; }
        h3 { color: var(--primary-color); border-bottom: 2px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }

        /* Item List Styling */
        .order-item { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed #ddd; font-size: 0.95em; }
        .order-item span { color: #555; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        .form-group input, .form-group textarea { 
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px;
            font-size: 1em; box-sizing: border-box; transition: 0.3s;
        }

        .summary-box { 
            background: #f0f8ff; padding: 20px; border-radius: 8px; 
            margin-bottom: 30px; border: 1px solid #d0e7ff;
        }
        .grand-total-box {
            font-size: 1.4em; font-weight: bold; color: var(--primary-color); 
            display: flex; justify-content: space-between;
            border-top: 2px solid #d0e7ff; padding-top: 15px; margin-top: 15px;
        }

        #payBtn { 
            background-color: var(--primary-color); color: white; padding: 15px 20px; 
            border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em; 
            font-weight: 700; width: 100%; transition: 0.3s;
        }
        #payBtn:hover { background-color: #4a1e78; }
        #payBtn:disabled { background-color: #ccc; cursor: not-allowed; }
        #paymentMessage { margin-top: 15px; padding: 15px; border-radius: 8px; font-weight: bold; text-align: center; }
    </style>
</head>
<body>
    <header class="navbar"></header>

    <div class="checkout-container">
        <h1>Complete Your Payment üí≥</h1>
        
        <div class="summary-box">
            <h3>Your Items</h3>
            <div id="itemsContainer">
                </div>
            <div class="grand-total-box">
                <span>Grand Total:</span>
                <span id="displayGrandTotal">KES 0</span>
            </div>
        </div>

        <form id="orderForm">
            <div class="form-group">
                <label for="address">Shipping Address</label>
                <textarea id="address" name="address" rows="3" required placeholder="Building, Street, County"></textarea>
            </div>

            <div class="form-group">
                <label for="phone">M-Pesa Number (254...)</label>
                <input type="tel" id="phone" name="phone" placeholder="2547XXXXXXXX" required>
            </div>

            <button type="submit" id="payBtn">Pay Everything with M-Pesa</button>
            <div id="paymentMessage"></div>
        </form>
    </div>

    <script>
        const itemsContainer = document.getElementById('itemsContainer');
        const displayGrandTotal = document.getElementById('displayGrandTotal');
        const orderForm = document.getElementById('orderForm');
        const payBtn = document.getElementById('payBtn');
        const messageElement = document.getElementById('paymentMessage');

        // 1. Load Everything from Cart
        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let grandTotal = 0;

        function displayOrder() {
            if (cart.length === 0) {
                window.location.href = 'cart.html'; // Send back if empty
                return;
            }

            itemsContainer.innerHTML = '';
            cart.forEach(item => {
                grandTotal += item.total;
                itemsContainer.innerHTML += `
                    <div class="order-item">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>Color: ${item.color} | Qty: ${item.quantity}</small>
                        </div>
                        <strong>KES ${item.total.toLocaleString()}</strong>
                    </div>
                `;
            });
            displayGrandTotal.innerText = `KES ${grandTotal.toLocaleString()}`;
        }

        displayOrder();

        function getUserIdFromToken(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(base64)).id;
            } catch (e) { return null; }
        }

        function startPolling(orderId) {
            const pollInterval = setInterval(async () => {
                try {
                    const res = await fetch(`http://localhost:3001/api/orders/status/${orderId}`);
                    const data = await res.json();
                    if (data.status === 'Processing') {
                        clearInterval(pollInterval);
                        messageElement.style.background = '#e7f4e9';
                        messageElement.style.color = '#1e4620';
                        messageElement.innerHTML = "‚úÖ Payment Successful! Your custom items will be ready in 2 days.";
                        localStorage.removeItem('cart');
                        if(typeof updateCartCount === 'function') updateCartCount();
                    }
                } catch (err) { console.error(err); }
            }, 3000);
        }

    orderForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const token = localStorage.getItem('authToken');
    
    if (!token) {
        alert("Please sign in first!");
        return;
    }

    payBtn.disabled = true;
    payBtn.innerText = 'Processing...';

    const payload = {
        items: cart, 
        totalAmount: grandTotal,
        address: document.getElementById('address').value,
        phone: document.getElementById('phone').value
    };

    try {
        // 1. Create the Order
        const orderRes = await fetch('http://localhost:3001/api/orders/create-bulk', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify(payload)
        });

        const orderData = await orderRes.json();

        if (!orderRes.ok) {
            throw new Error(orderData.message || "Failed to create order");
        }

        // 2. Initiate M-Pesa STK Push (Only if order was created)
        const mpesaRes = await fetch('http://localhost:3001/api/mpesa/stkpush', {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json', 
                'Authorization': `Bearer ${token}` 
            },
            body: JSON.stringify({ 
                phoneNumber: payload.phone, 
                orderId: orderData.orderId 
            })
        });

        const mpesaData = await mpesaRes.json();

        if (mpesaRes.ok) {
            messageElement.style.color = 'blue';
            messageElement.textContent = "Check your phone for the M-Pesa prompt!";
            startPolling(orderData.orderId);
        } else {
            throw new Error(mpesaData.message || "M-Pesa push failed");
        }

    } catch (err) {
        messageElement.style.color = 'red';
        messageElement.textContent = `‚ùå ${err.message}`;
        payBtn.disabled = false;
        payBtn.innerText = 'Confirm and pay with M-Pesa';
    }
});    
    </script>
</body>
</html>